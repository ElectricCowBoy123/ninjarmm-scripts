#region Declaration & Validation
# Ensure regkey dirs are created if they don't already exist
if (-not (Test-Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\DIT")) {
  New-Item -Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\DIT" -Force
}
if (-not (Test-Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced")) {
  New-Item -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Force
}
if (-not (Test-Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\HideDesktopIcons\NewStartPanel")) {
  New-Item -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\HideDesktopIcons\NewStartPanel" -Force
}

Add-Type -AssemblyName System.Windows.Forms

$oldErrorActionPreference = $ErrorActionPreference
$ErrorActionPreference = 'SilentlyContinue'
# Check if regkey runflag exists
try {
  [string]$strSDIVal = (Get-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\DIT' -Name 'SDI').SDI
} catch {
  $strSDIVal = $null
}
$ErrorActionPreference = $oldErrorActionPreference
#endregion

#region Function Declaration
function funcGetDesktopResolution {
  $screen = [System.Windows.Forms.Screen]::PrimaryScreen
  return "{0}x{1}" -f $screen.Bounds.Width, $screen.Bounds.Height
}
#endregion

#region Logic
if($strSDIVal -ne '1'){
  try {
    # Ensure Desktop Icons are not hidden
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'HideIcons' -Value 0 -Type DWORD -Force

    # Show Recyclebin Icon
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\HideDesktopIcons\NewStartPanel' -Name '{645FF040-5081-101B-9F08-00AA002F954E}' -Value 0 -Type DWORD -Force

    # Show Home folder icon
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\HideDesktopIcons\NewStartPanel' -Name '{59031A47-3F72-44A7-89C5-5595FE6B30EE}' -Value 0 -Type DWORD -Force

    # Show My PC icon
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\HideDesktopIcons\NewStartPanel' -Name '{20D04FE0-3AEA-1069-A2D8-08002B30309D}' -Value 0 -Type DWORD -Force
    

    $strCurrentResolution = funcGetDesktopResolution

    if($strCurrentResolution -eq '1440x900'){
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "FFlags" -Value 0x40200224 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "Mode" -Value 0x00000001 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "LogicalViewMode" -Value 0x00000003 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "IconSize" -Value 0x00000030 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "Sort" -Value ([byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)) -Type Binary -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "GroupView" -Value 0x00000000 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "GroupByKey:FMTID" -Value "{00000000-0000-0000-0000-000000000000}" -Type String -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "GroupByKey:PID" -Value 0x00000000 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "GroupByDirection" -Value 0x00000001 -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "IconNameVersion" -Value 0x00000001 -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'IconLayouts' -Type Binary -Value $([byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3a,0x00,0x3a,0x00,0x7b,0x00,0x32,0x00,0x30,0x00,0x44,0x00,0x30,0x00,0x34,0x00,0x46,0x00,0x45,0x00,0x30,0x00,0x2d,0x00,0x33,0x00,0x41,0x00,0x45,0x00,0x41,0x00,0x2d,0x00,0x31,0x00,0x30,0x00,0x36,0x00,0x39,0x00,0x2d,0x00,0x41,0x00,0x32,0x00,0x44,0x00,0x38,0x00,0x2d,0x00,0x30,0x00,0x38,0x00,0x30,0x00,0x30,0x00,0x32,0x00,0x42,0x00,0x33,0x00,0x30,0x00,0x33,0x00,0x30,0x00,0x39,0x00,0x44,0x00,0x7d,0x00,0x3e,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3a,0x00,0x3a,0x00,0x7b,0x00,0x35,0x00,0x39,0x00,0x30,0x00,0x33,0x00,0x31,0x00,0x41,0x00,0x34,0x00,0x37,0x00,0x2d,0x00,0x33,0x00,0x46,0x00,0x37,0x00,0x32,0x00,0x2d,0x00,0x34,0x00,0x34,0x00,0x41,0x00,0x37,0x00,0x2d,0x00,0x38,0x00,0x39,0x00,0x43,0x00,0x35,0x00,0x2d,0x00,0x35,0x00,0x35,0x00,0x39,0x00,0x35,0x00,0x46,0x00,0x45,0x00,0x36,0x00,0x42,0x00,0x33,0x00,0x30,0x00,0x45,0x00,0x45,0x00,0x7d,0x00,0x3e,0x00,0x5c,0x00,0x20,0x00,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3a,0x00,0x3a,0x00,0x7b,0x00,0x36,0x00,0x34,0x00,0x35,0x00,0x46,0x00,0x46,0x00,0x30,0x00,0x34,0x00,0x30,0x00,0x2d,0x00,0x35,0x00,0x30,0x00,0x38,0x00,0x31,0x00,0x2d,0x00,0x31,0x00,0x30,0x00,0x31,0x00,0x42,0x00,0x2d,0x00,0x39,0x00,0x46,0x00,0x30,0x00,0x38,0x00,0x2d,0x00,0x30,0x00,0x30,0x00,0x41,0x00,0x41,0x00,0x30,0x00,0x30,0x00,0x32,0x00,0x46,0x00,0x39,0x00,0x35,0x00,0x34,0x00,0x45,0x00,0x7d,0x00,0x3e,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3f,0x01,0x00,0x00,0x00,0x80,0x41,0x00,0x00,0x00,0x41,0x02,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3f,0x01,0x00,0x00,0x00,0x90,0x41,0x00,0x00,0xe0,0x40,0x02,0x00)) -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'ColInfo' -Type Binary -Value $([byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfd,0xdf,0xdf,0xfd,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x30,0xf1,0x25,0xb7,0xef,0x47,0x1a,0x10,0xa5,0xf1,0x02,0x60,0x8c,0x9e,0xeb,0xac,0x0a,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0xdf,0x90,0x7e,0xe7,0x71,0x62,0x5b,0x4f,0x83,0x4f,0x2d,0xd1,0xf2,0x45,0xdd,0xa4,0x02,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0x30,0xf1,0x25,0xb7,0xef,0x47,0x1a,0x10,0xa5,0xf1,0x02,0x60,0x8c,0x9e,0xeb,0xac,0x0c,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0xa6,0x6a,0x63,0x28,0x3d,0x95,0xd2,0x11,0xb5,0xd6,0x00,0xc0,0x4f,0xd9,0x18,0xd0,0x0b,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x30,0xf1,0x25,0xb7,0xef,0x47,0x1a,0x10,0xa5,0xf1,0x02,0x60,0x8c,0x9e,0xeb,0xac,0x0e,0x00,0x00,0x00,0x90,0x00,0x00,0x00)) -Force
    }
    else {
      # Set registry values using Set-ItemProperty
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'FFlags' -Value ([convert]::ToUInt32("40200224", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'Mode' -Value ([convert]::ToUInt32("00000001", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'LogicalViewMode' -Value ([convert]::ToUInt32("00000003", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'IconSize' -Value ([convert]::ToUInt32("00000030", 16)) -Type DWord -Force
      Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\Shell\Bags\1\Desktop" -Name "Sort" -Value ([byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)) -Type Binary -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'GroupView' -Value ([convert]::ToUInt32("00000000", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'GroupByKey:FMTID' -Value "{00000000-0000-0000-0000-000000000000}" -Type String -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'GroupByKey:PID' -Value ([convert]::ToUInt32("00000000", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'GroupByDirection' -Value ([convert]::ToUInt32("00000001", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'IconNameVersion' -Value ([convert]::ToUInt32("00000001", 16)) -Type DWord -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'IconLayouts' -Type Binary -Value $([byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3a,0x00,0x3a,0x00,0x7b,0x00,0x32,0x00,0x30,0x00,0x44,0x00,0x30,0x00,0x34,0x00,0x46,0x00,0x45,0x00,0x30,0x00,0x2d,0x00,0x33,0x00,0x41,0x00,0x45,0x00,0x41,0x00,0x2d,0x00,0x31,0x00,0x30,0x00,0x36,0x00,0x39,0x00,0x2d,0x00,0x41,0x00,0x32,0x00,0x44,0x00,0x38,0x00,0x2d,0x00,0x30,0x00,0x38,0x00,0x30,0x00,0x30,0x00,0x32,0x00,0x42,0x00,0x33,0x00,0x30,0x00,0x33,0x00,0x30,0x00,0x39,0x00,0x44,0x00,0x7d,0x00,0x3e,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3a,0x00,0x3a,0x00,0x7b,0x00,0x35,0x00,0x39,0x00,0x30,0x00,0x33,0x00,0x31,0x00,0x41,0x00,0x34,0x00,0x37,0x00,0x2d,0x00,0x33,0x00,0x46,0x00,0x37,0x00,0x32,0x00,0x2d,0x00,0x34,0x00,0x34,0x00,0x41,0x00,0x37,0x00,0x2d,0x00,0x38,0x00,0x39,0x00,0x43,0x00,0x35,0x00,0x2d,0x00,0x35,0x00,0x35,0x00,0x39,0x00,0x35,0x00,0x46,0x00,0x45,0x00,0x36,0x00,0x42,0x00,0x33,0x00,0x30,0x00,0x45,0x00,0x45,0x00,0x7d,0x00,0x3e,0x00,0x5c,0x00,0x20,0x00,0x00,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3a,0x00,0x3a,0x00,0x7b,0x00,0x36,0x00,0x34,0x00,0x35,0x00,0x46,0x00,0x46,0x00,0x30,0x00,0x34,0x00,0x30,0x00,0x2d,0x00,0x35,0x00,0x30,0x00,0x38,0x00,0x31,0x00,0x2d,0x00,0x31,0x00,0x30,0x00,0x31,0x00,0x42,0x00,0x2d,0x00,0x39,0x00,0x46,0x00,0x30,0x00,0x38,0x00,0x2d,0x00,0x30,0x00,0x30,0x00,0x41,0x00,0x41,0x00,0x30,0x00,0x30,0x00,0x32,0x00,0x46,0x00,0x39,0x00,0x35,0x00,0x34,0x00,0x45,0x00,0x7d,0x00,0x3e,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x3f,0x01,0x00,0x00,0x00,0x80,0x41,0x00,0x00,0x00,0x41,0x02,0x00)) -Force
      Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\Shell\Bags\1\Desktop' -Name 'ColInfo' -Type Binary -Value $([byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfd,0xdf,0xdf,0xfd,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x30,0xf1,0x25,0xb7,0xef,0x47,0x1a,0x10,0xa5,0xf1,0x02,0x60,0x8c,0x9e,0xeb,0xac,0x0a,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0xdf,0x90,0x7e,0xe7,0x71,0x62,0x5b,0x4f,0x83,0x4f,0x2d,0xd1,0xf2,0x45,0xdd,0xa4,0x02,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0x30,0xf1,0x25,0xb7,0xef,0x47,0x1a,0x10,0xa5,0xf1,0x02,0x60,0x8c,0x9e,0xeb,0xac,0x0c,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0xa6,0x6a,0x63,0x28,0x3d,0x95,0xd2,0x11,0xb5,0xd6,0x00,0xc0,0x4f,0xd9,0x18,0xd0,0x0b,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x30,0xf1,0x25,0xb7,0xef,0x47,0x1a,0x10,0xa5,0xf1,0x02,0x60,0x8c,0x9e,0xeb,0xac,0x0e,0x00,0x00,0x00,0x90,0x00,0x00,0x00)) -Force
    }
  }
  catch {
    throw "[Error] Failed to write essential keys to registry $($_.Exception)"
  }
  # RESTART EXPLORER
$strBatContent = @"
@echo off
taskkill /f /im explorer.exe >nul 2>&1
timeout /t 1 /nobreak > nul
start explorer.exe
"@

  $strBatFilePath = "$env:Temp\res.bat"

  # Create the batch file using Out-File
  $strBatContent | Out-File -FilePath $strBatFilePath -Encoding ASCII

  # Execute the batch file
  $objProcess = Start-Process -FilePath $strBatFilePath -NoNewWindow -PassThru
  $objProcess.WaitForExit()
  
  Start-Sleep -Seconds 3

  $objWMAProcs = Get-Process | Where-Object { $_.ProcessName -eq 'WWAHost' } -ErrorAction SilentlyContinue
  if($null -ne $objWMAProcs){
    foreach ($objWMAProc in $objWMAProcs) {
      & taskkill /pid $objWMAProc.Id /f
    }
  }
  New-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\DIT' -Name 'SDI' -PropertyType 'String' -Value '1' -ErrorAction SilentlyContinue
  exit 0
}
if($strSDIVal -eq '1') {
  Write-Host "[Informational] Desktop Position Script Already Ran!"
  exit 0
}
#endregion